<!DOCTYPE html>
<html ng-app="DigestCycleApp">
    <head>
        <title>Digest Cycle - Method $watch</title>
        <meta charset="UTF-8">
        <script src="../libs/angular/angular.min.js"></script>
        <link href="../libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <script>
            
            var app = angular.module("DigestCycleApp", []);
            
            /**
             * $watcher
             */
            app.controller("WatcherCtrl", function($scope) {
                
                $scope.count = 0;
                
                $scope.changeCounter = function(value) {
                    $scope.count += value;
                };
                
                $scope.$watch('count', function(newValue, oldValue) {
                    $scope.lastChange = "from " + oldValue + " to " + newValue;
                });
                
            });
            
            /**
             * Parent controller for controllers with timer
             */
            app.controller("TimerParentCtrl", function($scope, $rootScope) {
                
                $scope.currentTimerBlock = "";
                $scope.timerCaption = "Start timer";
                $scope.count = 0; 
                
                $scope._toggleTimer = function(block, setTimer) {
                    var previousBlock = $scope.currentTimerBlock;
                    if ($scope.currentTimerBlock != '') {
                        $rootScope.$broadcast('stopTimer');
                    } 
                    if (previousBlock != block) {
                        $scope.currentTimerBlock = block;
                        $scope.timerCaption = "Stop timer";
                        console.log("ROOT.START");
                        setTimer();
                    }
                };
                
                $scope._stopTimer = function(stopTimer) {
                    stopTimer();
                    console.log("ROOT.STOP");
                    $scope.timerCaption = "Start timer";
                    $scope.currentTimerBlock = "";
                    $scope.count = 0; 
                }
                
                $scope.$watch('count', function(newValue, oldValue) {
                    $scope.countChange = "from " + oldValue + " to " + newValue;
                });
                
            });
            
            /**
             * Without $digest
             */
            app.controller("WithoutDigestCtrl", function($scope) {

                var currentTimer = undefined;

                $scope.toggleTimer = function(block) {
                    $scope._toggleTimer(block, function() {
                        console.log("WITH.START");
                        currentTimer = setInterval(function() {
                            $scope.count++;
                        }, 1000);
                    });
                }

                $scope.$on("stopTimer", function() {
                    $scope._stopTimer(function() {
                        console.log("WITH.STOP");
                        clearInterval(currentTimer);
                    });
                });
        
            });

            /**
             * With $digest
             */
            app.controller("WithDigestCtrl", function($scope) {

                var currentTimer = undefined;

                $scope.setTimer = function() {
                    console.log("WITH.START");
                    currentTimer = setInterval(function() {
                        $scope.count++;
                        $scope.$digest();
                    }, 1000);
                }

                $scope.stopTimer = function() {
                    console.log("WITH.STOP");
                    clearInterval(currentTimer);
                }
        
            });
            
            /**
             * With $apply
             */
            /*app.controller("WithApplyCtrl", function($scope) {

                $scope.count = 0;

                setInterval(function() {
                    //$scope.$apply(function() {
                      //  $scope.count++;
                    // });
                }, 1000)
                
                $scope.$watch('count', function(newValue, oldValue) {
                    $scope.countChange = "from " + oldValue + " to " + newValue;
                });
        
            });*/
            
            /**
             * Without $apply
             */
            /*app.controller("WithoutApplyCtrl", function($scope) {

                $scope.count = 0;

                setInterval(function() {
                    $scope.count++;
                }, 1000)
                
                $scope.$watch('count', function(newValue, oldValue) {
                    $scope.countChange = "from " + oldValue + " to " + newValue;
                });
        
            });*/
            
        </script>
    </head>
    <body class="container">
        
        <h1>Digest Cycle Methods</h1>

        <div ng-controller="WatcherCtrl">

            <h2>Method $watch</h2>
            <p>
                Current count value: {{count}}
            </p>
            <p>
                Change count value:
                <button class="btn btn-default" ng-click="changeCounter(1)">
                    +1
                </button>
                <button class="btn btn-default" ng-click="changeCounter(-1)">
                    -1
                </button>
            </p>
            <p ng-if="lastChange">
                Last count change: {{lastChange}}
            </p>
            
        </div>
        
        <!-- *************************************************************** -->
        
        <div ng-controller="TimerParentCtrl">
            
            <h2>Method $digest</h2>
            
            <div ng-controller="WithoutDigestCtrl">
                <h4>Interval increments value every 1 second without $digest</h4>
                <p>Value: {{count}}</p>
                <p>
                    <button class="btn btn-default"
                            class="btn"
                            ng-class="'btn-' 
                                 + (currentTimerBlock == 'without-digest' ? 'danger' : 'success')"
                            ng-click="toggleTimer('without-digest')">
                        {{timerCaption}}
                    </button>
                </p>
                <p>Last change: {{countChange}}</p>
                <p>Value aren't updated because digest cycle work in setInterval function</p>
            </div>
            
            <div ng-controller="WithDigestCtrl">
                <h4>Interval increments value every 1 second with $digest</h4>
                <p>Value: {{count}}</p>
                <p>
                    <button class="btn btn-default"
                            class="btn"
                            ng-class="'btn-' 
                                 + (currentTimerBlock == 'with-digest' ? 'danger' : 'success')"
                            ng-click="toggleTimer('with-digest')">
                        {{timerCaption}}
                    </button>
                </p>
                <p>Last change: {{countChange}}</p>
                <p>Value updated because digest cycle executed manually with method $digest</p>
            </div>
            
        </div>
        
        
        
        
            
        
            <!--
        
        <h2>Method $apply</h2>
            
        <div ng-controller="WithoutApplyCtrl">
            <h4>Interval increments value every 1 second without $apply</h4>
            <p>Value: {{count}}</p>
            <p>Last change: {{countChange}}</p>
            <p>Value aren't updated because digest cycle work in setInterval function</p>
        </div>
            
        <div ng-controller="WithApplyCtrl">
            <h4>Interval increments value every 1 second with $apply</h4>
            <p>Value: {{count}}</p>
            <p>Last change: {{countChange}}</p>
            <p>Value updated because digest cycle executed manually with method $apply</p>
        </div>
        -->
        
    </body>
</html>
